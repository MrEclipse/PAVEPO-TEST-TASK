# Audio Upload Service

Это API для загрузки аудио-файлов, реализованное с использованием FastAPI, асинхронного SQLAlchemy и Docker. Пользователи могут присваивать файлам имя через API. Авторизация пользователей реализована через Yandex OAuth, после чего внутренние запросы аутентифицируются с помощью JWT-токенов. Файлы сохраняются локально, а БД – PostgreSQL 16.

## Функциональность

- **Авторизация через Yandex**  
  Пользователь проходит OAuth-авторизацию через Yandex.  
  - `GET /auth/yandex/login` – перенаправляет на страницу авторизации Яндекса.  
  - `GET /auth/yandex/callback` – получает код, обменивает его на токен от Яндекса, запрашивает данные пользователя, создаёт (или находит) пользователя в БД и возвращает JWT (access_token).

- **Обновление токена**  
  - `POST /auth/refresh` – выдаёт новый JWT на основе текущего пользователя.

- **Управление пользователями**  
  - `GET /users/me` – получить информацию о себе.  
  - `PUT /users/me` – обновить свои данные.  
  - `GET /users` – (только для суперпользователей) получить список всех пользователей.  
  - `DELETE /users/{user_id}` – (только для суперпользователей) удалить пользователя.

- **Работа с аудио-файлами**  
  - `POST /upload` – загрузить аудио-файл, указав имя.  
  - `GET /audio-files` – получить список загруженных файлов с именами и путями к файлам.

## Требования

- Docker и Docker Compose (для Windows Docker Desktop достаточно).
- Bash-терминал (для запуска скрипта `setup_environmental.sh`).
- Доступ к Docker Hub (для загрузки образов).

## Установка и запуск

### 1. Настройка окружения

Запустите скрипт `setup_environmental.sh` из bash-терминала для настройки связей и окружения:

```bash
./setup_environmental.sh
```

2. Сборка и запуск контейнеров
Запустите Docker Compose с командой:

```bash
docker-compose up --build -d
```

Примечание:
Если сервис базы данных (db) не загружается (например, появляется ошибка TLS handshake timeout), откройте настройки Docker Desktop и добавьте строку для зеркала реестра (например, в настройках Docker Engine добавьте "registry-mirrors": ["https://mirror.gcr.io/"]). Затем перезапустите Docker Desktop.

3. Авторизация через Yandex и получение JWT
Swagger UI не позволяет логиниться напрямую для обеспечения безопасности. Поэтому:

Скопируйте ссылку:
http://localhost:8000/auth/yandex/login

Откройте её в браузере и пройдите процесс авторизации через Яндекс.

После успешной авторизации вы будете перенаправлены на /auth/yandex/callback – в ответе вы получите JSON с полем access_token.

Скопируйте этот access_token.

4. Авторизация в Swagger
В Swagger UI нажмите кнопку Authorize.

В появившемся поле введите токен в формате:
```
Bearer <access_token>
```
Например:
```
Bearer 1234567890abcdef
```
После авторизации вы сможете вызывать защищённые эндпоинты.

5. Суперпользователь
Первый пользователь, прошедший авторизацию через Yandex, автоматически становится суперпользователем.

Суперпользователь может просматривать всех пользователей с помощью эндпоинта:
GET /users

Любой пользователь может изменить свои данные через:
PUT /users/me

6. Работа с аудио-файлами
Загрузите аудио-файл с указанием имени через эндпоинт:
POST /upload

Получите список ваших аудио-файлов (с указанием имени и локального пути) через эндпоинт:
GET /audio-files

Структура эндпоинтов
Авторизация:

/auth/yandex/login – перенаправление на страницу авторизации Яндекса.

/auth/yandex/callback – обработка обратного вызова от Яндекса, создание/поиск пользователя, выдача JWT.

/auth/refresh – обновление внутреннего JWT.

Пользователь:

/users/me (GET) – получить данные текущего пользователя.

/users/me (PUT) – обновить данные текущего пользователя.

/users (GET, суперпользователь) – просмотреть список всех пользователей.

/users/{user_id} (DELETE, суперпользователь) – удалить пользователя.

Аудио-файлы:

/upload (POST) – загрузка аудио-файла с указанием имени.

/audio-files (GET) – получение списка аудио-файлов пользователя с путями к файлам.
